<!DOCTYPE html>
<html>
    <head>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.10.5/css/jquery.dataTables.css">
	<style type="text/css" class="init">
	 td.dir {font-weight: bold; color: #00A1CB; }
	 td.git {font-weight: bold; color: #00BA88; }
	 td.annex {font-weight: bold; color: #EC6C20; }
	 td.broken {color:#E53B51; }
	 td.link {color: #FFD03C;  }
	 td.file {color: #67CDDC;  }
	</style>
    </head>
    <body>
	<table id="directory" class="display" width="100%" cellspacing="0"></table>
	<script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.3.min.js"></script>
	<script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.10.5/jquery.dataTables.min.js"></script>
	<script>
	 function directory(url) {
	     var url = (getParameterByName('dir') ? getParameterByName('dir') + ".dir.json": ".dir.json");

	     var table = $('#directory').DataTable( {
		 "async": true,    //async get json
		 "paging": false,  //ensure scrolling instead of pages
		 "ajax": {         //specify url to get json from ajax
		     "url": url,
		     "dataSrc": "nodes"
		 },
		 "columns": [      //select columns and their names from json
		     { "data": "name", title: "Name" },
		     { "data": "size", title: "Size" },
		     { "data": "date", title: "Date" },
		     { "data": "path", title: "Path" },
		     { "data": "type", title: "Type" },
		 ],
		 //update css of row based on type of node
		 "createdRow": function ( row, data, index ) {
		     if ( data.type == 'dir' ) {
			 $('td', row).eq(0).addClass('dir');
			 $('td', row).eq(1).addClass('dir');
			 $('td', row).eq(2).addClass('dir');
		     }
		     else if ( data.type == 'git' ) {
			 $('td', row).eq(0).addClass('git');
			 $('td', row).eq(1).addClass('git');
			 $('td', row).eq(2).addClass('git');
		     }
		     else if ( data.type == 'annex' ) {
			 $('td', row).eq(0).addClass('annex');
			 $('td', row).eq(1).addClass('annex');
			 $('td', row).eq(2).addClass('annex');
		     }
		     else if ( data.type == 'broken-link' ) {
			 $('td', row).eq(0).addClass('broken');
			 $('td', row).eq(1).addClass('broken');
			 $('td', row).eq(2).addClass('broken');
		     }
		     else if ( data.type == 'link' ) {
			 $('td', row).eq(0).addClass('link');
			 $('td', row).eq(1).addClass('link');
			 $('td', row).eq(2).addClass('link');
		     }
		     else if ( data.type == 'file' ) {
			 $('td', row).eq(0).addClass('file');
			 $('td', row).eq(1).addClass('file');
			 $('td', row).eq(2).addClass('file');
		     }
		 },
		 // add click handlers to each row(cell) once table initialised
		 "initComplete": function () {
		     var api = this.api();
		     api.$('tr').click( function () {           		                   // on clicking a row element
			 var data = table.row( this ).data();                                      // extract its data json from table
			 if (data.type == 'dir' || data.type == 'git' || data.type == 'annex') {   // if clicked row of directory type
			     // update url to load json from specified directory
			     window.location.search = '?dir=' + (data.name == ".." ? parent_url(url).replace('.dir.json', ''): url.replace('.dir.json', data.name + '/'));
			 }
		     });
		 }
	     });

	     table.columns([3,4]).visible(false, false);
	     
	     return table;
	 }

	 // construct parent url path
	 function parent_url(url) {  url_array = url.split(/[\\/]/);  url_array.splice(-2,1);  return url_array.join('/');  }

	 //extract GET parameters from URL
	 function getParameterByName(name, url) {
	     // refer https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
	     if (!url) url = window.location.href;
	     name = name.replace(/[\[\]]/g, "\\$&");
	     var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		 results = regex.exec(url);
	     if (!results) return null;
	     if (!results[2]) return '';
	     return decodeURIComponent(results[2].replace(/\+/g, " "));
	 }

	 $(document).ready(function() {
	     //get dir parameter from url to visit required directory's json
	     var table = directory();
	 });
	</script>
    </body>
</html>
