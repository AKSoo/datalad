<!DOCTYPE html>
<html>
    <head>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.10.5/css/jquery.dataTables.css">
	<style type="text/css" class="init">
	 td.dir {font-weight: bold; color: #00A1CB; }
	 td.git {font-weight: bold; color: #00BA88; }
	 td.annex {font-weight: bold; color: #EC6C20; }
	 td.link-broken {color:#E53B51; }
	 td.link {color: #FFD03C;  }
	 td.file {color: #67CDDC;  }
	</style>
    </head>
    <body>
	<table id="directory" class="display" width="100%" cellspacing="0"></table>
	<script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.3.min.js"></script>
	<script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.10.5/jquery.dataTables.min.js"></script>
	<script>
	 function directory(url) {
	     // construct path to metadata json based on directory to be rendered argument passed in url
	     var url = (getParameterByName('dir') ? getParameterByName('dir') + ".dir.json": url_exists(url) ? url : ".dir.json");

	     var table = $('#directory').DataTable( {
		 "async": true,    //async get json
		 "paging": false,  //ensure scrolling instead of pages
		 "ajax": {         //specify url to get json from ajax
		     "url": url,
		     "dataSrc": "nodes"
		 },
	         "order": [[ 3, "asc" ]],
		 "columns": [      //select columns and their names from json
		     { "data": "name", title: "Name" },
                     { "data": "date", title: "Date" },
                     { "data": "size", title: "Size" },
		     { "data": "type", title: "Type" },
                     { "data": "path", title: "Path" },
	         ],
		 //update css of visible columns in each row based on their node type
		 "createdRow": function ( row, data, index ) {
		     for(i = 0; i < 4; i++)
			 $('td', row).eq(i).addClass(data.type);
		 },
		 // add click handlers to each row(cell) once table initialised
		 "initComplete": function () {
		     var api = this.api();
		     api.$('tr').click( function () {           		                   // on clicking a row element
			 var data = table.row( this ).data();                                      // extract its data json from table
			 if (data.type == 'dir' || data.type == 'git' || data.type == 'annex') {   // if clicked row of directory type
                            // update url to load json from selected directory
                            window.location.search = '?dir=' + (data.name == ".." ? parent_url(url).replace('.dir.json', ''): url.replace('.dir.json', data.name + '/'));
			 }
			 else if (data.type == 'file' || data.type == 'link') {
			    // update url to load json from selected directory
                            window.location.assign(url.replace('.dir.json', data.name))
	               }
		     });
		 }
	     });
	     table.columns([4]).visible(false);  //hide complete path and file type columns
	     return table;
	 }
	 // check if url exists
	 function url_exists(url) { var http = new XMLHttpRequest();  http.open('HEAD', url, false);  http.send();  return http.status!=404; }

	 // construct parent path of url passed
	 function parent_url(url) {  url_array = url.split(/[\\/]/);  url_array.splice(-2,1);  return url_array.join('/');  }

	 //extract GET parameters from URL
	 function getParameterByName(name, url) {
	     // refer https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
	     if (!url) url = window.location.href;
	     name = name.replace(/[\[\]]/g, "\\$&");
	     var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		 results = regex.exec(url);
	     if (!results) return null;
	     if (!results[2]) return '';
	     return decodeURIComponent(results[2].replace(/\+/g, " "));
	 }

	 $(document).ready(function() {
	     var table = directory();   // construct table based on files in directory and their metadata
	 });
	</script>
    </body>
</html>
